BootStrap: docker
From: tensorflow/tensorflow:2.17.0-gpu
#Stage: build

%setup
    touch /file1
    touch ${SINGULARITY_ROOTFS}/file2

%files
    /file1
    /file1 /opt
    thisroot.sh /hepsw/thisroot_2.sh

%environment
    #export LISTEN_PORT=12345
    export LC_ALL=C
    export PYTHIA8DATA=/usr/local/share/Pythia8/xmldoc
    export EVTGEN_ROOT=/usr/local
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib
    export RAPIDSIM_ROOT=/usr/local
    cd /hepsw/root
    source bin/thisroot_2.sh
    export GEANT4_DATA_DIR=/usr/local/share/Geant4/data
    export LD_PRELOAD=/usr/local/lib/libG4zlib.so:/usr/local/lib/libG4ptl.so.2.3.3:/usr/local/lib/libG4clhep.so:/usr/local/lib/libG4global.so:/usr/local/lib/libG4intercoms.so:/usr/local/lib/libG4graphics_reps.so:/usr/local/lib/libG4interfaces.so:/usr/local/lib/libG4materials.so:/usr/local/lib/libG4particles.so:/usr/local/lib/libG4analysis.so:/usr/local/lib/libG4geometry.so:/usr/local/lib/libG4track.so:/usr/local/lib/libG4geomtext.so:/usr/local/lib/libG4digits_hits.so:/usr/local/lib/libG4processes.so:/usr/local/lib/libG4parmodels.so:/usr/local/lib/libG4tracking.so:/usr/local/lib/libG4event.so:/usr/local/lib/libG4run.so:/usr/local/lib/libG4readout.so:/usr/local/lib/libG4mctruth.so:/usr/local/lib/libG4error_propagation.so:/usr/local/lib/libG4modeling.so:/usr/local/lib/libG4vis_management.so:/usr/local/lib/libG4FR.so:/usr/local/lib/libG4visHepRep.so:/usr/local/lib/libG4RayTracer.so:/usr/local/lib/libG4Tree.so:/usr/local/lib/libG4VRML.so:/usr/local/lib/libG4physicslists.so:/usr/local/lib/libG4GMocren.so:/usr/local/lib/libG4ToolsSG.so:/usr/local/lib/libG4ptl.so.2:/usr/local/lib/libG4ptl.so


%post
    CORES=$(nproc --all)  # Assign the result to CORES
    export CORES          # Export the CORES variable

    # Update package list and install any additional packages if needed
    apt-get update && apt-get install -y \
        vim \
        git \
        wget \
        htop
    apt update
    apt install -y cmake

    apt-get update && apt-get install -y netcat
    apt install -y wget
    apt install -y curl git
    #NOW=`date`
    #echo "export NOW=\"${NOW}\"" >> $SINGULARITY_ENVIRONMENT
    apt install -y cmake build-essential
    apt install -y rsync
    apt install -y libtool
    apt install -y snapd
    apt install -y gfortran
    apt install -y vim

    apt install -y dpkg-dev cmake g++ gcc binutils libx11-dev libxpm-dev libxft-dev libxext-dev python3.10 libssl-dev
    apt install -y python2.7

    apt install -y python3-pip

    mkdir /usr/local/lib/python3.10/site-packages

    cd /

    cd /hepsw
    wget https://root.cern/download/root_v6.30.04.Linux-centosstream9-x86_64-gcc11.3.tar.gz
    tar -zxvf root_v6.30.04.Linux-centosstream9-x86_64-gcc11.3.tar.gz
    cd root
    # There is a bug in thisroot.sh provided by root. This patch should fix it.
    cp /hepsw/thisroot_2.sh bin/thisroot_2.sh
    . bin/thisroot_2.sh

    cd /hepsw
    wget https://pythia.org/download/pythia83/pythia8311.tgz
    tar -zxvf pythia8311.tgz
    cd pythia8311
    ./configure --prefix=/usr/local
    make -j$CORES
    make install
    cd /hepsw
    rm -rv pythia8311
    rm pythia8311.tgz


    cd /hepsw
    # The server was dead on June 27, 2024 10:39, so I switched to gitlab
    # wget http://hepmc.web.cern.ch/hepmc/releases/HepMC3-3.2.6.tar.gz
    # tar -xzf HepMC3-3.2.6.tar.gz
    wget https://gitlab.cern.ch/hepmc/HepMC3/-/archive/3.2.6/HepMC3-3.2.6.tar.gz
    tar -xzf HepMC3-3.2.6.tar.gz
    mkdir hepmc3-build
    cd hepmc3-build
    cmake -DCMAKE_INSTALL_PREFIX=/usr/local   \
        -DHEPMC3_ENABLE_ROOTIO:BOOL=OFF            \
        -DHEPMC3_ENABLE_PROTOBUFIO:BOOL=OFF        \
        -DHEPMC3_ENABLE_TEST:BOOL=OFF              \
        -DHEPMC3_INSTALL_INTERFACES:BOOL=ON        \
        -DHEPMC3_BUILD_STATIC_LIBS:BOOL=OFF        \
        -DHEPMC3_BUILD_DOCS:BOOL=OFF     \
        -DHEPMC3_ENABLE_PYTHON:BOOL=ON   \
        -DHEPMC3_PYTHON_VERSIONS=2.7,3.10     \
        -DHEPMC3_Python_SITEARCH310=/usr/local/lib/python3.10/site-packages \
        -DHEPMC3_Python_SITEARCH27=/usr/local/lib/python2.7/site-packages \
        ../HepMC3-3.2.6
    make -j$CORES
    make install
    cd /hepsw
    rm HepMC3-3.2.6.tar.gz
    rm -rv  hepmc3-build
    rm -rv HepMC3-3.2.6

    cd /hepsw
    wget http://tauolapp.web.cern.ch/tauolapp/resources/TAUOLA.1.1.8/TAUOLA.1.1.8-LHC.tar.gz
    tar -zxvf TAUOLA.1.1.8-LHC.tar.gz
    cd TAUOLA
    ./configure --with-hepmc3 --without-hepmc --prefix=/usr/local --with-pythia8
    ./config.status
    make -j$CORES
    make install
    cd /hepsw
    rm TAUOLA.1.1.8-LHC.tar.gz
    rm -rv TAUOLA


    cd /hepsw
    wget http://photospp.web.cern.ch/photospp/resources/PHOTOS.3.64/PHOTOS.3.64.tar.gz
    tar -zxvf PHOTOS.3.64.tar.gz
    cd PHOTOS
    ./configure --without-hepmc --with-hepmc3 --prefix=/usr/local
    ./config.status
    make -j$CORES
    make install
    cd /hepsw
    rm PHOTOS.3.64.tar.gz
    rm -rv PHOTOS
#
##    cd /hepsw
##    wget https://evtgen.hepforge.org/downloads?f=EvtGen-02.02.01.tar.gz -O evtgen.tar.gz
##    tar -zxvf evtgen.tar.gz
##    cd EvtGen/*
##    bash setupEvtGen.sh
##    cd /usr/local
##    ln -s share/EvtGen/evt.pdl evt.pdl
#
    cd /hepsw
    wget https://evtgen.hepforge.org/downloads?f=EvtGen-02.02.01.tar.gz -O evtgen.tar.gz
    tar -zxvf evtgen.tar.gz
    cd EvtGen/*
    mkdir build
    cd build
    cmake -DEVTGEN_PHOTOS=ON -DEVTGEN_PYTHIA=ON -DEVTGEN_TAUOLA=ON -DHEPMC3_ROOT_DIR=/usr/local -DPhotos++_ROOT_DIR=/usr/local ..
    make -j$CORES
    make install
#    bash setupEvtGen.sh
    cd /usr/local
    ln -s share/EvtGen/evt.pdl evt.pdl
    cd /hepsw
    rm evtgen.tar.gz
    rm -rv EvtGen


    cd /hepsw
#    wget https://github.com/gcowan/RapidSim/archive/refs/tags/v1.5.tar.gz -O RapidSim.tar.gz
    git clone https://github.com/shahrukhqasim/RapidSim.git
#    tar -zxvf RapidSim.tar.gz
#    cd RapidSim-1.5
    cd RapidSim
    export EVTGEN_ROOT=/usr/local
    mkdir build
    cd build
    cmake ../ -DCMAKE_INSTALL_PREFIX=/usr/local
    make -j$CORES
    make install
    cd /hepsw
#    rm RapidSim.tar.gz
    rm -rv RapidSim

    #cd /hepsw
    #wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin
    #mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600
    #wget https://developer.download.nvidia.com/compute/cuda/11.8.0/local_installers/cuda-repo-ubuntu2204-11-8-local_11.8.0-520.61.05-1_amd64.deb
    #dpkg -i cuda-repo-ubuntu2204-11-8-local_11.8.0-520.61.05-1_amd64.deb
    #cp /var/cuda-repo-ubuntu2204-11-8-local/cuda-*-keyring.gpg /usr/share/keyrings/
    #apt update
    #DEBIAN_FRONTEND=noninteractive apt install -y cuda

    #wget https://developer.download.nvidia.com/compute/redist/cudnn/v8.6.0/local_installers/11.8/cudnn-linux-x86_64-8.6.0.163_cuda11-archive.tar.xz
    #tar -xvf cudnn-linux-x86_64-8.6.0.163_cuda11-archive.tar.xz
    #cp cudnn-linux-x86_64-8.6.0.163_cuda11-archive/include/* /usr/local/cuda-11.8/include/
    #cp cudnn-linux-x86_64-8.6.0.163_cuda11-archive/lib/* /usr/local/cuda-11.8/lib64/

    #rm cuda-repo-ubuntu2204-11-8-local_11.8.0-520.61.05-1_amd64.deb
    #rm cudnn-linux-x86_64-8.6.0.163_cuda11-archive.tar.xz


    cd /hepsw
    wget https://gitlab.cern.ch/geant4/geant4/-/archive/v11.2.2/geant4-v11.2.2.tar.gz
    tar -zxvf geant4-v11.2.2.tar.gz
    cd geant4-v11.2.2
    mkdir build
    cd build
    cmake -DGEANT4_INSTALL_DATA=ON ..
    make -j$CORES
    make install
    cd /hepsw
    rm geant4-v11.2.2.tar.gz
    rm -rv geant4-v11.2.2

    pip3 install torch==2.4.0 torchvision==0.19.0 torchaudio==2.4.0 --index-url https://download.pytorch.org/whl/cu124
    apt install -y nvidia-cuda-dev
    export FORCE_CUDA=1
    export TORCH_CUDA_ARCH_LIST="5.0;6.0;7.0;7.5;8.0;8.6;9.0+PTX"


    # This thing is effing slow. This is because it does not have an option to run multiple processes in parallel
    # for the compilation and it takes forever. Unbelievable.
    # Same reason why it is at the end, so we know everythign else works before checking this.
    pip3 install "git+https://github.com/facebookresearch/pytorch3d.git@stable"


    apt-get clean && rm -rf /var/lib/apt/lists/*

%runscript
    echo "ml4physics Container"
    echo "Author: Shah Rukh Qasim <shah.rukh.qasim@cern.ch>."
    echo "TensorFlow 2.17 [CUDA 12.3], PyTorch 2.4.0 [CUDA 12.4], Geant4 11.2.2"
    exec /bin/bash

%startscript
    #nc -lp $LISTEN_PORT

%test
    echo "Hello world!"

%labels
    Author shah.rukh.qasim@cern.ch
    Version v4.0

%help
    This container is designed to allow running of RapidSim and related software with ease.



